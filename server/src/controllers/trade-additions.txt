// Search for stocks globally
export const searchStocks = async (req: Request, res: Response) => {
  try {
    const { q } = req.query;
    
    if (!q || typeof q !== 'string') {
      return res.status(400).json({ error: 'Search query required' });
    }

    if (!stockMarketAPI.isConfigured()) {
      return res.status(503).json({ 
        error: 'Stock market API not configured. Please set FINNHUB_API_KEY environment variable.' 
      });
    }

    const results = await stockMarketAPI.searchStocks(q);
    res.json(results);
  } catch (error: any) {
    console.error('Error searching stocks:', error);
    res.status(500).json({ error: 'Error searching stocks' });
  }
};

// Get detailed stock information
export const getStockDetails = async (req: Request, res: Response) => {
  try {
    const { symbol } = req.params;
    
    if (!symbol) {
      return res.status(400).json({ error: 'Stock symbol required' });
    }

    if (!stockMarketAPI.isConfigured()) {
      // Fallback to simulator if API not configured
      const price = priceSimulator.getPrice('stock', symbol);
      if (price > 0) {
        return res.json({
          symbol,
          price,
          name: symbol,
          source: 'simulator'
        });
      }
      return res.status(404).json({ error: 'Stock not found' });
    }

    // Fetch quote and company profile in parallel
    const [quote, profile] = await Promise.all([
      stockMarketAPI.getQuote(symbol),
      stockMarketAPI.getCompanyProfile(symbol)
    ]);

    if (!quote) {
      return res.status(404).json({ error: 'Stock not found or market closed' });
    }

    res.json({
      symbol: quote.symbol,
      price: quote.price,
      change: quote.change,
      changePercent: quote.changePercent,
      high: quote.high,
      low: quote.low,
      open: quote.open,
      previousClose: quote.previousClose,
      name: profile?.name || symbol,
      exchange: profile?.exchange || 'N/A',
      industry: profile?.industry || 'N/A',
      marketCap: profile?.marketCapitalization || 0,
      logo: profile?.logo || '',
      source: 'finnhub'
    });
  } catch (error: any) {
    console.error('Error fetching stock details:', error);
    res.status(500).json({ error: 'Error fetching stock details' });
  }
};

// Get real-time quote for a stock
export const getStockQuote = async (req: Request, res: Response) => {
  try {
    const { symbol } = req.params;
    
    if (!symbol) {
      return res.status(400).json({ error: 'Stock symbol required' });
    }

    if (!stockMarketAPI.isConfigured()) {
      // Fallback to simulator
      const price = priceSimulator.getPrice('stock', symbol);
      if (price > 0) {
        return res.json({
          symbol,
          price,
          source: 'simulator'
        });
      }
      return res.status(404).json({ error: 'Stock not found' });
    }

    const quote = await stockMarketAPI.getQuote(symbol);
    
    if (!quote) {
      return res.status(404).json({ error: 'Stock not found or market closed' });
    }

    res.json(quote);
  } catch (error: any) {
    console.error('Error fetching stock quote:', error);
    res.status(500).json({ error: 'Error fetching stock quote' });
  }
};
