generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "mysql"
  url      = env("DATABASE_URL")
}

model activitylog {
  id        String   @id
  userId    String
  action    String
  details   Json?
  ipAddress String?
  isRead    Boolean  @default(false)
  createdAt DateTime @default(now())
  user      user     @relation(fields: [userId], references: [id], onDelete: Cascade, map: "ActivityLog_userId_fkey")

  @@index([userId], map: "ActivityLog_userId_fkey")
  @@index([isRead])
}

model copytradeattempt {
  id               String                      @id
  userId           String
  traderName       String
  assetSymbol      String
  assetType        copytradeattempt_assetType
  actionType       copytradeattempt_actionType
  profitPercentage Decimal?                    @db.Decimal(15, 2)
  createdAt        DateTime                    @default(now())
  user             user                        @relation(fields: [userId], references: [id], onDelete: Cascade, map: "CopyTradeAttempt_userId_fkey")

  @@index([userId], map: "CopyTradeAttempt_userId_fkey")
}

model deposit {
  id              String    @id
  userId          String
  amount          Decimal   @db.Decimal(15, 2)
  paymentMethod   String
  cryptoType      String?
  transactionHash String?
  proofNotes      String?   @db.Text
  status          String    @default("pending")
  settlementDetails Json?     // Store settlement details as JSON
  adminNotes      String?   @db.Text
  reviewedBy      String?
  reviewedAt      DateTime?
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt
  user            user      @relation(fields: [userId], references: [id], onDelete: Cascade, map: "Deposit_userId_fkey")

  @@index([userId], map: "Deposit_userId_fkey")
}

model grantapplication {
  id                 String                  @id
  userId             String
  grantType          String
  organizationName   String
  organizationType   String?
  contactName        String
  contactEmail       String
  contactPhone       String?
  projectDescription String                  @db.Text
  requestedAmount    Decimal                 @db.Decimal(15, 2)
  status             grantapplication_status @default(pending)
  adminNotes         String?                 @db.Text
  reviewedAt         DateTime?
  reviewedBy         String?
  createdAt          DateTime                @default(now())
  updatedAt          DateTime                @updatedAt
  user               user                    @relation(fields: [userId], references: [id], onDelete: Cascade, map: "GrantApplication_userId_fkey")

  @@index([userId], map: "GrantApplication_userId_fkey")
}

model holding {
  id            String            @id
  userId        String
  assetType     holding_assetType
  symbol        String
  assetName     String
  quantity      Decimal           @db.Decimal(20, 8)
  averagePrice  Decimal           @db.Decimal(15, 2)
  currentPrice  Decimal           @db.Decimal(15, 2)
  totalCost     Decimal           @db.Decimal(15, 2)
  currentValue  Decimal           @db.Decimal(15, 2)
  profitLoss    Decimal           @db.Decimal(15, 2)
  profitLossPct Decimal           @db.Decimal(10, 2)
  createdAt     DateTime          @default(now())
  updatedAt     DateTime          @updatedAt
  user          user              @relation(fields: [userId], references: [id], onDelete: Cascade, map: "Holding_userId_fkey")

  @@unique([userId, assetType, symbol], map: "Holding_userId_assetType_symbol_key")
  @@index([userId], map: "Holding_userId_idx")
}

model kycdocument {
  id           String                   @id
  userId       String
  documentType kycdocument_documentType
  fileUrl      String                   @db.Text
  status       kycdocument_status       @default(pending)
  createdAt    DateTime                 @default(now())
  user         user                     @relation(fields: [userId], references: [id], onDelete: Cascade, map: "KycDocument_userId_fkey")

  @@index([userId], map: "KycDocument_userId_fkey")
}

model passwordresets {
  id        String   @id
  email     String
  userId    String
  token     String   @unique(map: "PasswordResets_token_key")
  expiresAt DateTime
  used      Boolean  @default(false)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model profile {
  id                 String                @id
  userId             String                @unique(map: "Profile_userId_key")
  email              String
  fullName           String?
  phone              String?
  dateOfBirth        DateTime?
  nationality        String?
  countryOfResidence String?
  maritalStatus      String?
  taxId              String?
  isPep              Boolean               @default(false)
  pepDetails         String?               @db.Text
  kycStatus          String                @default("pending")
  accountStatus      profile_accountStatus @default(pending)
  hasBusiness        Boolean               @default(false)
  businessName       String?
  businessType       String?
  businessIndustry   String?
  businessTaxId      String?
  createdAt          DateTime              @default(now())
  updatedAt          DateTime              @updatedAt
  user               user                  @relation(fields: [userId], references: [id], onDelete: Cascade, map: "Profile_userId_fkey")
}

model trade {
  id          String          @id
  userId      String
  assetType   trade_assetType
  symbol      String
  assetName   String
  tradeType   String
  quantity    Decimal         @db.Decimal(20, 8)
  price       Decimal         @db.Decimal(15, 2)
  totalAmount Decimal         @db.Decimal(15, 2)
  fee         Decimal         @default(0.00) @db.Decimal(15, 2)
  status      trade_status    @default(executed)
  executedAt  DateTime        @default(now())
  createdAt   DateTime        @default(now())
  user        user            @relation(fields: [userId], references: [id], onDelete: Cascade, map: "Trade_userId_fkey")

  @@index([createdAt], map: "Trade_createdAt_idx")
  @@index([symbol], map: "Trade_symbol_idx")
  @@index([userId], map: "Trade_userId_idx")
}

model transaction {
  id          String             @id
  userId      String
  type        transaction_type
  amount      Decimal            @db.Decimal(15, 2)
  description String?            @db.Text
  status      transaction_status @default(completed)
  referenceId String?
  createdAt   DateTime           @default(now())
  user        user               @relation(fields: [userId], references: [id], onDelete: Cascade, map: "Transaction_userId_fkey")

  @@index([userId], map: "Transaction_userId_fkey")
}

model user {
  id                   String             @id
  email                String             @unique(map: "User_email_key")
  passwordHash         String?
  magicLinkToken       String?            @unique(map: "User_magicLinkToken_key")
  magicLinkExpires     DateTime?
  resetPasswordToken   String?            @unique(map: "User_resetPasswordToken_key")
  resetPasswordExpires DateTime?
  createdAt            DateTime           @default(now())
  updatedAt            DateTime           @updatedAt
  activitylog          activitylog[]
  copytradeattempt     copytradeattempt[]
  deposit              deposit[]
  grantapplication     grantapplication[]
  holding              holding[]
  kycdocument          kycdocument[]
  profile              profile?
  trade                trade[]
  transaction          transaction[]
  userrole             userrole[]
  wallet               wallet?
  withdrawal           withdrawal[]
  loginHistory         loginhistory[]
  userInvestments      UserInvestment[]
  algoApplication      ProprietaryAlgorithmApplication?
  algoAccess           UserAlgorithmAccess[]
}

model userrole {
  id     String        @id
  userId String
  role   userrole_role @default(user)
  user   user          @relation(fields: [userId], references: [id], onDelete: Cascade, map: "UserRole_userId_fkey")

  @@unique([userId, role], map: "UserRole_userId_role_key")
}

model wallet {
  id        String   @id
  userId    String   @unique(map: "Wallet_userId_key")
  balance   Decimal  @default(0.00) @db.Decimal(15, 2)
  currency  String   @default("USD")
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  user      user     @relation(fields: [userId], references: [id], onDelete: Cascade, map: "Wallet_userId_fkey")
}

model withdrawal {
  id               String    @id
  userId           String
  amount           Decimal   @db.Decimal(15, 2)
  withdrawalMethod String
  walletAddress    String?
  bankDetails      String?   @db.Text
  status           String    @default("pending")
  adminNotes       String?   @db.Text
  reviewedBy       String?
  reviewedAt       DateTime?
  createdAt        DateTime  @default(now())
  updatedAt        DateTime  @updatedAt
  user             user      @relation(fields: [userId], references: [id], onDelete: Cascade, map: "Withdrawal_userId_fkey")

  @@index([userId], map: "Withdrawal_userId_fkey")
}

model loginhistory {
  id            String   @id
  userId        String
  ipAddress     String?  @db.VarChar(45)
  userAgent     String?  @db.Text
  timestamp     DateTime @default(now()) @db.DateTime(3)
  success       Boolean  @default(true)
  failureReason String?
  user          user     @relation(fields: [userId], references: [id], onDelete: Cascade, map: "LoginHistory_userId_fkey")

  @@index([userId])
  @@index([timestamp])
}

enum holding_assetType {
  stock
  crypto
}

enum kycdocument_documentType {
  id
  passport
  drivers_license
  utility_bill
  bank_statement
}

enum trade_assetType {
  stock
  crypto
}

enum transaction_type {
  deposit
  withdrawal
  transfer
  trade_buy
  trade_sell
}

enum userrole_role {
  admin
  user
}

enum copytradeattempt_assetType {
  stock
  crypto
}

enum kycdocument_status {
  pending
  approved
  rejected
}

enum copytradeattempt_actionType {
  copy_trade
  apply_strategy
}

enum transaction_status {
  pending
  completed
  failed
  cancelled
}

enum grantapplication_status {
  pending
  under_review
  approved
  rejected
}

enum trade_status {
  pending
  executed
  cancelled
  failed
}

enum profile_accountStatus {
  active
  inactive
  pending
}

model InvestmentPlan {
  id               String           @id @default(uuid())
  name             String
  description      String           @db.Text
  durationDays     Int
  returnPercentage Decimal          @db.Decimal(5, 2)
  minAmount        Decimal          @db.Decimal(15, 2)
  maxAmount        Decimal          @db.Decimal(15, 2)
  isActive         Boolean          @default(true)
  createdAt        DateTime         @default(now())
  updatedAt        DateTime         @updatedAt
  userInvestments  UserInvestment[]
  algoAccess       UserAlgorithmAccess[]
}

model UserInvestment {
  id                  String            @id @default(uuid())
  userId              String
  planId              String
  amount              Decimal           @db.Decimal(15, 2)
  startDate           DateTime          @default(now())
  endDate             DateTime
  customDurationDays  Int?              // Admin-overridable duration
  status              investment_status @default(ACTIVE)
  expectedReturn      Decimal           @db.Decimal(15, 2)
  createdAt           DateTime          @default(now())
  updatedAt           DateTime          @updatedAt
  user                user              @relation(fields: [userId], references: [id], onDelete: Cascade)
  plan                InvestmentPlan    @relation(fields: [planId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([planId])
}

enum investment_status {
  ACTIVE
  COMPLETED
  CANCELLED
}

model ProprietaryAlgorithmApplication {
  id                    String                        @id @default(uuid())
  userId                String                        @unique
  // Section 1 - Personal Profile
  ageRange              String
  occupation            String
  occupationOther       String?
  industry              String
  // Section 2 - Income & Net Worth
  annualIncome          String
  netWorth              String
  liquidCapital         String
  // Section 3 - Investment Experience
  investingDuration     String
  assetsInvested        String                        // JSON array of selected options
  investmentKnowledge   String
  // Section 4 - Behavioural
  checkFrequency        String
  investorDescription   String
  // Section 5 - Risk Tolerance
  dropReaction          String
  whatMattersMost       String
  returnProfile         String
  // Section 6 - Time Horizon
  investmentHorizon     String
  // Section 7 - Management Style
  involvementLevel      String
  communicationPref     String
  // Section 8 - Allocation Psychology
  allocationPercentage  String
  // Section 9 - Expectations
  primaryGoal           String
  primaryConcern        String
  // Section 10 - Crypto
  holdsCrypto           String
  cryptoNetWorthPct     String?
  cryptoTypes           String?                       // JSON array
  cryptoStorage         String?
  cryptoExchanges       String?                       // if exchanges selected
  cryptoActivity        String?
  cryptoAllocation      String?
  cryptoDropReaction    String?
  // Admin
  status                algo_application_status       @default(pending)
  adminNotes            String?                       @db.Text
  reviewedAt            DateTime?
  reviewedBy            String?
  createdAt             DateTime                      @default(now())
  updatedAt             DateTime                      @updatedAt
  user                  user                          @relation(fields: [userId], references: [id], onDelete: Cascade)
  algoAccess            UserAlgorithmAccess?

  @@index([status])
}

model UserAlgorithmAccess {
  id                 String                           @id @default(uuid())
  userId             String
  applicationId      String                           @unique
  planId             String                           // The plan tier admin granted
  customDurationDays Int?                             // Optional duration override for this user
  grantedAt          DateTime                         @default(now())
  grantedBy          String?
  createdAt          DateTime                         @default(now())
  updatedAt          DateTime                         @updatedAt
  user               user                             @relation(fields: [userId], references: [id], onDelete: Cascade)
  application        ProprietaryAlgorithmApplication  @relation(fields: [applicationId], references: [id], onDelete: Cascade)
  plan               InvestmentPlan                   @relation(fields: [planId], references: [id])

  @@index([userId])
}

enum algo_application_status {
  pending
  under_review
  approved
  rejected
}

model AppSettings {
  id             String @id @default("main")
  usdtAddress    String
  btcAddress     String
  whatsappNumber String
}
